<script>
    window.__as24_gtm_container_id = 'GTM-MK57H2';

    var dataLayer = [
        {
            cmp_enabled: true
        }, {
            "dealer_sell_ID": "900000",
            "common_loginState": "logged_in|b2b"
        }, {
            "common_pageName": "de/vm/dealer/notset",
            "common_market": "vm",
            "common_category": "dealer",
            "common_group": "",
            "common_pageid": "notset",
            "common_layer": "",
            "common_attribute": "",
            "common_linkid": "",
            "common_linkgroup": ""
        }, {
            "common_pageName": "de/vm/dealer/overview",
            "common_market": "vm",
            "common_category": "dealer",
            "common_group": "",
            "common_pageid": "overview",
            "common_layer": "",
            "common_attribute": "",
            "common_linkid": "",
            "common_linkgroup": ""
        }, {
            "event": "data_ready"
        }
    ];
</script>

<script>
    (function () {
        "use strict";

        window.cmpEnabled = true;
        window.dataLayer = window.dataLayer || [];
        window
            .dataLayer
            .push({cmp_enabled: true});

        var tld = window
            .location
            .hostname
            .split(".")
            .pop();

        var cmpSiteIds = {
            at: "c8515c6b-cf35-47d8-8078-15cc075b3207",
            be: "a9a510e9-b6b9-4499-99f6-131880e92aaa",
            de: "ea93c094-1e43-49f8-8c62-75128f08f70b",
            es: "052e7f91-7b7c-432a-bb9e-d99911139da7",
            fr: "f6a34410-a99a-4e8d-836c-f19620914569",
            it: "7dc55efc-b43a-4ab6-a31b-d084591ee853",
            lu: "3f009a85-9789-4acc-a4a3-a6c45994c3ca",
            nl: "11590dc9-3700-43b4-aacd-731ef5261fdf"
        };

        loadCMPStub();
        loadCmpAsync();

        window.__cmp("getVendorConsents", null, function (vendorConsents) {
            window.__cmp("getAdditionalVendorConsents", null, function (additionalVendorConsents) {
                setDataLayerConsents(vendorConsents, additionalVendorConsents);
                loadGTM();
            });
        });

        window.__cmp("addEventListener", "consentToolShouldBeShown", function () {
            waitForIframe(function (ifr) {
                ifr.parentNode.style = "width: 100%; heigh: 100%; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000; background-color: rgba(0, 0, 0, 0.35);";
            });
        });

        function loadCMPStub() {
            if (!window.__cmp || typeof window.__cmp !== "function") {
                var faktorCmpStart = window.__cmp
                    ? window.__cmp.start
                    : {};

                window.__cmp = (function () {
                    var listen = window.attachEvent || window.addEventListener;
                    listen("message", function (event) {
                        window
                            .__cmp
                            .receiveMessage(event);
                    });

                    function addLocatorFrame() {
                        if (!window.frames["__cmpLocator"]) {
                            if (document.body) {
                                var frame = document.createElement("iframe");
                                frame.style.display = "none";
                                frame.name = "__cmpLocator";
                                document
                                    .body
                                    .appendChild(frame);
                            } else {
                                setTimeout(addLocatorFrame, 5);
                            }
                        }
                    }

                    addLocatorFrame();

                    var commandQueue = [];
                    var cmp = function (command, parameter, callback) {
                        if (command === "ping") {
                            if (callback) {
                                callback({
                                    gdprAppliesGlobally: !!(window.__cmp && window.__cmp.config && window.__cmp.config.storeConsentGlobally),
                                    cmpLoaded: false
                                });
                            }
                        } else {
                            commandQueue.push({command: command, parameter: parameter, callback: callback});
                        }
                    };
                    cmp.commandQueue = commandQueue;
                    cmp.receiveMessage = function (event) {
                        var data = event && event.data && event.data.__cmpCall;
                        if (data) {
                            commandQueue.push({callId: data.callId, command: data.command, parameter: data.parameter, event: event});
                        }
                    };

                    return cmp;
                })();

                window.__cmp.start = faktorCmpStart;
            }
        }

        function loadCmpAsync() {
            var cmpSiteId = cmpSiteIds[tld] || cmpSiteIds["de"];
            var script = document.createElement("script");
            var ref = document.getElementsByTagName("script")[0];
            ref
                .parentNode
                .insertBefore(script, ref);
            script.src = `https://config-prod.choice.faktor.io/${cmpSiteId}/faktor.js`;

            waitForIframe;
        }

        function waitForIframe(cb) {
            var ifr = document.querySelector("iframe#cmp-faktor-io-brand-consent-notice");
            if (ifr) {
                cb(ifr);
                return;
            }

            setTimeout(function () {
                waitForIframe(cb);
            }, 50);
        }

        function loadGTM() {
            console.log('hello', window.__as24_gtm_container_id);

            (function (w, d, s, l, i) {
                w[l] = w[l] || [];
                w[l].push({"gtm.start": new Date().getTime(), event: "gtm.js"});
                var f = d.getElementsByTagName(s)[0],
                    j = d.createElement(s),
                    dl = l != "dataLayer"
                        ? "&l=" + l
                        : "";
                j.async = true;
                j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
                f
                    .parentNode
                    .insertBefore(j, f);
            })(window, document, "script", "dataLayer", window.__as24_gtm_container_id);
        }

        function setDataLayerConsents(vendorConsents, additionalVendorConsents) {
            var facebookConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.purposeConsents[3] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[16];

            var googleAnalyticsConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[4];

            var googleAdsConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.purposeConsents[3] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[91];

            var bingConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.purposeConsents[3] && vendorConsents.purposeConsents[4] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[21];

            var mouseFlowConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[223];

            var kruxConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.purposeConsents[3] && vendorConsents.purposeConsents[4] && vendorConsents.purposeConsents[5] && additionalVendorConsents.vendorConsents[25];

            var criteoConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.vendorConsents[91];

            var rtbConsent = vendorConsents && vendorConsents.purposeConsents[1] && vendorConsents.purposeConsents[2] && vendorConsents.vendorConsents[16];

            window.dataLayer = window.dataLayer || [];
            window
                .dataLayer
                .push({
                    cmp_facebook_consent: facebookConsent,
                    cmp_googleAnalytics_consent: googleAnalyticsConsent,
                    cmp_googleAds_consent: googleAdsConsent,
                    cmp_bing_consent: bingConsent,
                    cmp_mouseFlow_consent: mouseFlowConsent,
                    cmp_krux_consent: kruxConsent,
                    cmp_criteo_consent: criteoConsent,
                    cmp_rtb_consent: rtbConsent
                });
        }
    })();
</script>